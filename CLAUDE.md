# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Synapse is an intelligent Zsh command suggestion daemon that provides real-time ghost text completions and an on-demand dropdown menu (like GitHub Copilot for the terminal). It consists of a Rust daemon communicating over a Unix domain socket with a Zsh plugin.

## Build & Development Commands

```bash
cargo build                          # Debug build
cargo build --release                # Release build
cargo test                           # Run all tests
cargo test test_name                 # Run a single test by name
cargo test --test spec_tests         # Run a specific test file
cargo test -- --nocapture            # Run tests with stdout visible
cargo clippy                         # Lint
cargo fmt                            # Format
```

Run the daemon in foreground for development:
```bash
cargo run -- start --foreground -vv
```

Dev workflow — build and activate in the current shell:
```bash
cargo build && eval "$(./target/debug/synapse)"
source dev/test.sh                   # Convenience: builds + activates
source dev/test.sh --release         # Same with release build
```

Running from `target/` auto-detects dev mode and creates a unique per-workspace socket so multiple worktrees don't conflict.

### CLI

| Command | Description |
|---|---|
| `synapse` | If run in a terminal: install to `~/.zshrc`. If piped: output shell init code. |
| `synapse stop` | Stop the daemon |
| `synapse status` | Show daemon status |

## Setup

Install pre-commit hooks (runs `cargo fmt --check` and `cargo clippy` before each commit):
```bash
./scripts/setup-hooks.sh
```

## Architecture

### Two-Process Model

1. **Zsh Plugin** (`plugin/synapse.zsh`) — Thin shell layer using `zle` widgets to capture keystrokes, render ghost text and dropdown menu via `POSTDISPLAY` + `region_highlight`, and communicate with the daemon over a Unix socket. Parses JSON responses with regex (no `jq` dependency). Dropdown uses `recursive-edit` with a custom `synapse-dropdown` keymap for modal navigation.

2. **Rust Daemon** (`src/main.rs`) — Single long-running Tokio async process serving all terminal sessions concurrently over a Unix domain socket at `$XDG_RUNTIME_DIR/synapse.sock`.

### Suggestion Pipeline (4-Layer Cascade)

All providers implement the `SuggestionProvider` trait (`src/providers/mod.rs`) with `suggest()` (single best) and `suggest_multi()` (top N for dropdown):

- **History** (`src/providers/history.rs`) — BTreeMap prefix search + Levenshtein fuzzy matching. Target: <5ms.
- **Spec** (`src/providers/spec.rs`) — Structured CLI completions from TOML specs and auto-generated project specs. Tokenizes buffer, walks spec tree, completes subcommands/options/arguments. Target: <10ms.
- **Filesystem** (`src/providers/filesystem.rs`) — File and directory completions with quoting/escaping support.
- **Environment** (`src/providers/environment.rs`) — PATH and virtualenv executable suggestions.

### Spec System

- **Data model** (`src/spec.rs`) — `CommandSpec`, `SubcommandSpec`, `OptionSpec`, `ArgSpec`, `GeneratorSpec`, `ArgTemplate`. All spec structs derive `Serialize` for TOML round-tripping.
- **Spec store** (`src/spec_store.rs`) — Loads built-in specs (embedded via `include_str!`), caches project specs per-cwd (5min TTL), runs generators with timeout and caching (30s TTL). Also manages background spec discovery and the discovered specs tier.
- **Auto-generation** (`src/spec_autogen.rs`) — Generates specs from project files (Makefile targets, package.json scripts, Cargo.toml, docker-compose services, Justfile recipes, Python tools). Also discovers specs for CLI tools built by the current project (Rust/clap, Go/cobra, Python/click).
- **Help parser** (`src/help_parser.rs`) — Parses `--help` output from CLI tools into `CommandSpec`. Handles clap, cobra, argparse, click, and POSIX help formats.
- **Spec cache** (`src/spec_cache.rs`) — Persistent disk cache for discovered specs at `~/synapse/specs/*.toml`. Supports staleness detection via timestamps.
- **Built-in specs** (`specs/builtin/*.toml`) — git, cargo, npm, docker, ls, grep, find, curl, ssh, python, pip.
- **Discovered specs** — Auto-generated by running `--help` on unknown commands. Triggered on command execution and unknown command suggestions. Persisted to `~/synapse/specs/`.
- **User specs** — `.synapse/specs/*.toml` in project root (highest priority).

**Spec resolution (4-tier priority):**
1. Project user specs (highest)
2. Project auto-generated specs
3. Built-in specs
4. Discovered specs (lowest)

### Response Flow

All providers run concurrently per request, are ranked, and the best suggestion is returned immediately.

### Key Subsystems

- **Ranking** (`src/ranking.rs`) — Weighted score merging (history: 0.30, spec: 0.50, recency: 0.20). Position-dependent weights adjust per cursor context. `rank_multi()` for dropdown: scores, deduplicates by text, sorts, truncates.
- **Security** (`src/security.rs`) — Scrubs paths, env vars, and sensitive command-like inputs.
- **Caching** — Providers and spec store use `moka::future::Cache` with TTL for hot paths.
- **Sessions** (`src/session.rs`) — Per-session state (cwd, recent commands, last buffer) identified by 12-char hex IDs.
- **Protocol** (`src/protocol.rs`) — Newline-delimited JSON. Request types: Suggest, ListSuggestions, Interaction, Ping, Shutdown, ReloadConfig, ClearCache. Response types: Suggestion, SuggestionList, Pong, Ack, Error. Suggestion sources: History, Spec, Filesystem, Environment. Suggestion kinds: Command, Subcommand, Option, Argument, File, History.
- **Logging** (`src/logging.rs`) — Append-only JSONL interaction log at `~/.local/share/synapse/interactions.jsonl` with rotation at 50MB.

### Config

User config at `~/.config/synapse/config.toml`. See `config.example.toml` for all options. Parsed in `src/config.rs`.

## Testing Patterns

- Integration tests live in `tests/` (protocol, history, context, security, spec).
- Tests that mutate env vars use `Mutex<()>` for serialization.
- Daemon lifecycle tests create in-process `UnixListener` instances.
- `tempfile::TempDir` and `tempfile::NamedTempFile` are used for isolated test directories.
- Spec tests create temp directories with project files (Cargo.toml, Makefile) to test auto-generation and completion.

## Design Reference

`docs/design-doc.md` contains the full architecture spec including protocol details, performance targets, and security model.
