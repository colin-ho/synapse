# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Synapse is a **spec engine + NL translation layer** for Zsh. It discovers/generates CLI specs (from `--help` parsing, project files, and user TOML) and exports them as compsys `_arguments` completion functions. It also provides natural language to command translation via the `? query` prefix. Synapse integrates with the existing zsh ecosystem (zsh-autosuggestions for ghost text, fzf-tab for fuzzy menus, Atuin for history search).

It consists of a Rust daemon communicating over a Unix domain socket with a thin Zsh plugin.

## Build & Development Commands

```bash
cargo build                          # Debug build
cargo build --release                # Release build
cargo test                           # Run all tests
cargo test test_name                 # Run a single test by name
cargo test --test integration_tests   # Run a specific test file
cargo test -- --nocapture            # Run tests with stdout visible
cargo clippy                         # Lint
cargo fmt                            # Format
```

Run the daemon in foreground for development:
```bash
cargo run -- start --foreground -vv
```

Dev workflow — build and activate in the current shell:
```bash
cargo build && eval "$(./target/debug/synapse)"
source dev/test.sh                   # Convenience: builds + activates
source dev/test.sh --release         # Same with release build
```

Running from `target/` auto-detects dev mode and creates a unique per-workspace socket so multiple worktrees don't conflict.

### CLI

| Command | Description |
|---|---|
| `synapse` | If run in a terminal: install to `~/.zshrc`. If piped: output shell init code. |
| `synapse start` | Start the daemon (with `--foreground`, `-v`/`-vv`/`-vvv`, `--log-file`, `--socket-path`) |
| `synapse stop` | Stop the daemon |
| `synapse status` | Show daemon status |
| `synapse install` | Add `eval "$(synapse)"` to `~/.zshrc` |
| `synapse generate-completions` | Generate compsys completion files from known specs |
| `synapse complete <cmd> [ctx...]` | Query daemon for dynamic completion values |
| `synapse probe` | Protocol-level debugging (with `--request`, `--stdio`) |

## Setup

Install pre-commit hooks (runs `cargo fmt --check` and `cargo clippy` before each commit):
```bash
./scripts/setup-hooks.sh
```

## Architecture

### Two-Process Model

1. **Zsh Plugin** (`plugin/synapse.zsh`) — Thin shell layer providing NL translation mode (`? query` prefix), command execution reporting (triggers spec discovery), connection management, and daemon lifecycle. Uses `recursive-edit` with a `synapse-dropdown` keymap for NL result navigation.

2. **Rust Daemon** (`src/main.rs`) — Single long-running Tokio async process serving all terminal sessions concurrently over a Unix domain socket at `$XDG_RUNTIME_DIR/synapse.sock`.

### Core Capabilities

1. **Spec Engine** — Discovers/generates CLI specs and exports them as compsys `_arguments` completion functions. Generated files go to `~/.local/share/synapse/completions/` and are added to `fpath` by shell init.
2. **NL Translator** — `? query` prefix translates natural language to shell commands via LLM.
3. **Background Tasks** — Spec discovery on unknown commands, compsys regeneration on discovery, dynamic completion serving.

### Spec System

- **Data model** (`src/spec.rs`) — `CommandSpec`, `SubcommandSpec`, `OptionSpec`, `ArgSpec`, `GeneratorSpec`, `ArgTemplate`. All spec structs derive `Serialize` for TOML round-tripping.
- **Spec store** (`src/spec_store.rs`) — Caches project specs per-cwd (5min TTL), runs generators with timeout and caching. Manages background spec discovery and writes compsys completion files directly.
- **Compsys export** (`src/compsys_export.rs`) — Converts `CommandSpec` into zsh `_arguments` completion functions. Handles options, subcommands, args, generators, templates, aliases, and recursive commands.
- **Auto-generation** (`src/spec_autogen.rs`) — Generates specs from project files (Makefile targets, package.json scripts, Cargo.toml, docker-compose services, Justfile recipes, Python tools).
- **Discovered specs** — Auto-generated by running `--help` on unknown commands. Triggered on command execution. Written directly as compsys files to `~/.local/share/synapse/completions/`.
- **User specs** — `.synapse/specs/*.toml` in project root (highest priority).

**Spec resolution (2-tier priority):**
1. User project specs (`.synapse/specs/*.toml`) — highest
2. Project auto-generated specs (Makefile, package.json, etc.)

Discovery writes compsys files directly — the compsys file IS the persistent cache.

### Key Subsystems

- **Security** — Path scrubbing in `src/llm.rs` (`scrub_env_values`), command blocklist in `src/daemon/state.rs` (`CompiledBlocklist`).
- **Caching** — Spec store uses `moka::future::Cache` with TTL for hot paths.
- **Sessions** (`src/session.rs`) — Per-session state (cwd tracking) identified by 12-char hex IDs.
- **Protocol** (`src/protocol.rs`) — Newline-delimited JSON requests, TSV responses. Request types: NaturalLanguage, CommandExecuted, Complete, Ping, Shutdown, ReloadConfig, ClearCache. Response types: SuggestionList, CompleteResult, Pong, Ack, Error.
- **Logging** (`src/logging.rs`) — Append-only JSONL interaction log at `~/.local/share/synapse/interactions.jsonl` with rotation at 50MB.
- **Zsh completion scanner** (`src/zsh_completion.rs`) — Gap detection: scans fpath for existing compsys functions to avoid generating duplicates.

### Config

User config at `~/.config/synapse/config.toml`. See `config.example.toml` for all options. Parsed in `src/config.rs`.

Sections: `[general]`, `[spec]`, `[security]`, `[llm]`, `[completions]`, `[logging]`.

## Testing Patterns

- Integration tests live in `tests/` (integration_tests, probe_tests).
- Tests that mutate env vars use `Mutex<()>` for serialization.
- Daemon lifecycle tests create in-process `UnixListener` instances.
- `tempfile::TempDir` and `tempfile::NamedTempFile` are used for isolated test directories.
- Spec tests create temp directories with project files (Cargo.toml, Makefile) to test auto-generation and completion.
